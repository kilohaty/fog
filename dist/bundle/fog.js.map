{"version":3,"file":"fog.js","sources":["../../src/global-config.ts","../../src/utils/index.ts","../../src/fog.ts","../../src/index.ts"],"sourcesContent":["export interface IConfig {\n  display?: string;\n  width?: number;\n  height?: number;\n  backgroundColor?: string;\n  transitionDuration?: number;\n  retryTimes?: number;\n  retryDuration?: number;\n  miniImgRule?: Function;\n  errorImage?: string;\n}\n\nexport const config: IConfig = {\n  display: 'inline-block',\n  width: 1,\n  height: 1,\n  transitionDuration: 1,\n  retryTimes: 2,\n  retryDuration: 3000\n};\n\nexport function setConfig(options: IConfig) {\n  Object.assign(config, options);\n}\n","let canvas: HTMLCanvasElement;\n\nfunction loadImage(src): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.crossOrigin = 'anonymous';\n    img.onload = resolve.bind(null, img);\n    img.onerror = reject;\n    img.src = src;\n  })\n}\n\nfunction getSkeletonImageURL(fillStyle: string): string {\n  if (!canvas) {\n    canvas = document.createElement('canvas');\n    canvas.width = 1;\n    canvas.height = 1;\n  }\n  const ctx = canvas.getContext('2d');\n  ctx.save();\n  ctx.fillStyle = fillStyle;\n  ctx.fillRect(0, 0, 1, 1);\n  ctx.restore();\n  return canvas.toDataURL();\n}\n\nexport {\n  loadImage,\n  getSkeletonImageURL\n}\n","import {config as conf} from './global-config';\nimport {getSkeletonImageURL, loadImage} from './utils';\n\nconst emptyImgUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=';\n\nexport interface IFogOptions {\n  el: HTMLImageElement;\n  onFail?: Function; // full img fail\n  onSuccess?: Function; // full img success\n  onComplete?: Function; // full img complete (fail or success)\n}\n\nfunction noop() {\n  return false;\n}\n\nexport default class Fog {\n  readonly el: HTMLImageElement;\n  readonly width: number;\n  readonly height: number;\n  readonly miniImgUrl: string;\n  readonly fullImgUrl: string;\n  readonly onFail: Function;\n  readonly onSuccess: Function;\n  readonly onComplete: Function;\n  private elDiv: HTMLDivElement;\n  private elCanvas: HTMLCanvasElement;\n  private miniImgRetryCount: number = 0;\n  private fullImgRetryCount: number = 0;\n  private miniImgLoaded: boolean = false;\n  private fullImgLoaded: boolean = false;\n  private hasLoadErrImg: boolean = false;\n\n  constructor(options: IFogOptions | HTMLImageElement) {\n    if (options instanceof HTMLElement) {\n      options = {el: options};\n    }\n    this.el = options.el;\n    this.width = +this.el.getAttribute('data-width') || conf.width;\n    this.height = +this.el.getAttribute('data-height') || conf.height;\n    this.fullImgUrl = this.el.getAttribute('data-src');\n    this.miniImgUrl = this.getMiniImgUrl();\n    this.onFail = options.onFail || noop;\n    this.onSuccess = options.onSuccess || noop;\n    this.onComplete = options.onComplete || noop;\n\n    this.prepareDOM();\n    this.loadMiniImg();\n    this.loadFullImg();\n  }\n\n  private getMiniImgUrl(): string {\n    let url = this.el.getAttribute('data-src-mini');\n    if (!url && conf.miniImgRule) {\n      const src = this.el.getAttribute('data-src');\n      url = conf.miniImgRule(src);\n    }\n    return url;\n  }\n\n  private createDiv(): HTMLDivElement {\n    const div: HTMLDivElement = document.createElement('div');\n    div.setAttribute('class', 'fog-wrapper');\n    div.style.cssText = `\n      display: ${conf.display}; \n      position: relative;\n      width: ${this.width};\n      height: ${this.height};\n      font-size: 0;`;\n    return div;\n  }\n\n  private createCanvas(): HTMLCanvasElement {\n    const canvas = document.createElement('canvas');\n    canvas.width = this.width;\n    canvas.height = this.height;\n    canvas.style.cssText = `\n      position: absolute; \n      z-index: 1;\n      left: 0;\n      top:0;\n      opacity: 0;\n      transition: opacity linear ${conf.transitionDuration}s;`;\n    return canvas;\n  }\n\n  private isFullImgFail() {\n    return !this.fullImgLoaded && this.fullImgRetryCount >= conf.retryTimes;\n  }\n\n  private isMiniImgFail() {\n    return !this.miniImgLoaded && this.miniImgRetryCount >= conf.retryTimes;\n  }\n\n  private prepareDOM() {\n    if (conf.backgroundColor) {\n      this.el.src = getSkeletonImageURL(conf.backgroundColor);\n    } else {\n      this.el.src = emptyImgUrl;\n    }\n    this.el.style.width = this.width + 'px';\n    this.el.style.height = this.height + 'px';\n\n    this.elDiv = this.createDiv();\n    this.elCanvas = this.createCanvas();\n    if (this.el.nextElementSibling) {\n      this.el.parentNode.insertBefore(this.elDiv, this.el.nextElementSibling)\n    } else {\n      this.el.parentNode.appendChild(this.elDiv)\n    }\n\n    this.elDiv.appendChild(this.el);\n    this.elDiv.appendChild(this.elCanvas);\n  }\n\n  private onMiniImgLoad(img) {\n    this.miniImgLoaded = true;\n\n    if (this.fullImgLoaded) {\n      return;\n    }\n\n    const ctx = this.elCanvas.getContext('2d');\n    ctx.save();\n    const radio = this.width / img.width;\n    ctx.scale(radio, radio);\n    ctx.drawImage(img, 0, 0);\n    ctx.restore();\n    this.elCanvas.style.opacity = '1';\n  }\n\n  private loadMiniImg() {\n    if (!this.miniImgUrl) {\n      return;\n    }\n    loadImage(this.miniImgUrl)\n      .then(this.onMiniImgLoad.bind(this))\n      .catch(err => {\n        console.error(err);\n        if (this.isMiniImgFail() && this.isFullImgFail()) {\n          this.loadErrorImg();\n        } else {\n          setTimeout(() => {\n            // retry util full img loaded success\n            if (this.miniImgRetryCount < conf.retryTimes && !this.fullImgLoaded) {\n              this.miniImgRetryCount++;\n              this.loadMiniImg();\n            }\n          }, conf.retryDuration);\n        }\n      });\n  }\n\n  private onFullImgLoad() {\n    this.el.src = this.fullImgUrl;\n    this.elCanvas.style.opacity = '0';\n    this.el.setAttribute('data-fog-status', 'success');\n    this.fullImgLoaded = true;\n    this.onSuccess();\n    this.onComplete();\n  }\n\n  private loadFullImg() {\n    if (!this.fullImgUrl) {\n      throw Error('full img url is not found!');\n    }\n    loadImage(this.fullImgUrl)\n      .then(this.onFullImgLoad.bind(this))\n      .catch(err => {\n        console.error(err);\n        if (this.fullImgRetryCount < conf.retryTimes) {\n          this.fullImgRetryCount++;\n          setTimeout(() => {\n            this.loadFullImg();\n          }, conf.retryDuration);\n        } else {\n          this.onFail();\n          this.onComplete();\n          if (this.isMiniImgFail()) {\n            // load error img when mini and full img were all failed\n            this.loadErrorImg();\n          }\n        }\n      });\n  }\n\n  private loadErrorImg() {\n    if (!conf.errorImage || this.hasLoadErrImg) {\n      return;\n    }\n    this.hasLoadErrImg = true;\n    loadImage(conf.errorImage)\n      .then(() => {\n        this.el.src = conf.errorImage;\n        this.elCanvas.style.opacity = '0';\n      })\n      .catch(console.error);\n  }\n}\n","import {setConfig} from './global-config';\nimport Fog, {IFogOptions} from './fog';\n\nfunction init(options: IFogOptions | HTMLImageElement) {\n  return new Fog(options);\n}\n\nexport default {init, setConfig};\n"],"names":["canvas","config","display","width","height","transitionDuration","retryTimes","retryDuration","loadImage","src","Promise","resolve","reject","img","Image","crossOrigin","onload","bind","onerror","noop","options","this","HTMLElement","el","getAttribute","conf","fullImgUrl","miniImgUrl","getMiniImgUrl","onFail","onSuccess","onComplete","prepareDOM","loadMiniImg","loadFullImg","Fog","url","miniImgRule","div","document","createElement","setAttribute","style","cssText","fullImgLoaded","fullImgRetryCount","miniImgLoaded","miniImgRetryCount","backgroundColor","fillStyle","ctx","getContext","save","fillRect","restore","toDataURL","getSkeletonImageURL","elDiv","createDiv","elCanvas","createCanvas","nextElementSibling","parentNode","insertBefore","appendChild","radio","scale","drawImage","opacity","then","onMiniImgLoad","catch","err","console","error","_this","isMiniImgFail","isFullImgFail","loadErrorImg","setTimeout","Error","onFullImgLoad","errorImage","hasLoadErrImg","init","setConfig","Object","assign"],"mappings":"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"}