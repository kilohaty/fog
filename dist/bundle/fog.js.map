{"version":3,"file":"fog.js","sources":["../../src/global-config.ts","../../src/utils/index.ts","../../src/fog.ts","../../src/index.ts"],"sourcesContent":["export interface IConfig {\n  display?: string;\n  width?: number;\n  height?: number;\n  backgroundColor?: string;\n  transitionDuration?: number;\n  retryTimes?: number;\n  retryDuration?: number;\n  miniImgRule?: Function;\n  errorImage?: string;\n}\n\nexport const config: IConfig = {\n  display: 'inline-block',\n  width: 1,\n  height: 1,\n  transitionDuration: 1,\n  retryTimes: 2,\n  retryDuration: 3000\n};\n\nexport function setConfig(options: IConfig) {\n  Object.assign(config, options);\n}\n","let canvas: HTMLCanvasElement;\n\nfunction loadImage(src): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.onload = resolve.bind(null, img);\n    img.onerror = reject;\n    img.src = src;\n  })\n}\n\nfunction getSkeletonImageURL(fillStyle: string): string {\n  if (!canvas) {\n    canvas = document.createElement('canvas');\n    canvas.width = 1;\n    canvas.height = 1;\n  }\n  const ctx = canvas.getContext('2d');\n  ctx.save();\n  ctx.fillStyle = fillStyle;\n  ctx.fillRect(0, 0, 1, 1);\n  ctx.restore();\n  return canvas.toDataURL();\n}\n\nexport {\n  loadImage,\n  getSkeletonImageURL\n}\n","import {config as conf} from './global-config';\nimport {getSkeletonImageURL, loadImage} from './utils';\n\nconst emptyImgUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=';\n\nexport interface IFogOptions {\n  el: HTMLImageElement;\n  onFail?: Function; // full img fail\n  onSuccess?: Function; // full img success\n  onComplete?: Function; // full img complete (fail or success)\n}\n\nfunction noop() {\n  return false;\n}\n\nexport default class Fog {\n  readonly el: HTMLImageElement;\n  readonly width: number;\n  readonly height: number;\n  readonly miniImgUrl: string;\n  readonly fullImgUrl: string;\n  readonly onFail: Function;\n  readonly onSuccess: Function;\n  readonly onComplete: Function;\n  private elDiv: HTMLDivElement;\n  private elCanvas: HTMLCanvasElement;\n  private miniImgRetryCount: number = 0;\n  private fullImgRetryCount: number = 0;\n  private miniImgLoaded: boolean = false;\n  private fullImgLoaded: boolean = false;\n  private hasLoadErrImg: boolean = false;\n\n  constructor(options: IFogOptions) {\n    this.el = options.el;\n    this.width = +this.el.getAttribute('data-width') || conf.width;\n    this.height = +this.el.getAttribute('data-height') || conf.height;\n    this.fullImgUrl = this.el.getAttribute('data-src');\n    this.miniImgUrl = this.getMiniImgUrl();\n    this.onFail = options.onFail || noop;\n    this.onSuccess = options.onSuccess || noop;\n    this.onComplete = options.onComplete || noop;\n\n    this.prepareDOM();\n    this.loadMiniImg();\n    this.loadFullImg();\n  }\n\n  private getMiniImgUrl(): string {\n    let url = this.el.getAttribute('data-src-mini');\n    if (!url && conf.miniImgRule) {\n      const src = this.el.getAttribute('data-src');\n      url = conf.miniImgRule(src);\n    }\n    return url;\n  }\n\n  private createDiv(): HTMLDivElement {\n    const div: HTMLDivElement = document.createElement('div');\n    div.setAttribute('class', 'fog-wrapper');\n    div.style.cssText = `\n      display: ${conf.display}; \n      position: relative;\n      width: ${this.width};\n      height: ${this.height};\n      font-size: 0;`;\n    return div;\n  }\n\n  private createCanvas(): HTMLCanvasElement {\n    const canvas = document.createElement('canvas');\n    canvas.width = this.width;\n    canvas.height = this.height;\n    canvas.style.cssText = `\n      position: absolute; \n      z-index: 1;\n      left: 0;\n      top:0;\n      opacity: 0;\n      transition: opacity linear ${conf.transitionDuration}s;`;\n    return canvas;\n  }\n\n  private isFullImgFail() {\n    return !this.fullImgLoaded && this.fullImgRetryCount >= conf.retryTimes;\n  }\n\n  private isMiniImgFail() {\n    return !this.miniImgLoaded && this.miniImgRetryCount >= conf.retryTimes;\n  }\n\n  private prepareDOM() {\n    if (conf.backgroundColor) {\n      this.el.src = getSkeletonImageURL(conf.backgroundColor);\n    } else {\n      this.el.src = emptyImgUrl;\n    }\n    this.el.style.width = this.width + 'px';\n    this.el.style.height = this.height + 'px';\n\n    this.elDiv = this.createDiv();\n    this.elCanvas = this.createCanvas();\n    if (this.el.nextElementSibling) {\n      this.el.parentNode.insertBefore(this.elDiv, this.el.nextElementSibling)\n    } else {\n      this.el.parentNode.appendChild(this.elDiv)\n    }\n\n    this.elDiv.appendChild(this.el);\n    this.elDiv.appendChild(this.elCanvas);\n  }\n\n  private onMiniImgLoad(img) {\n    if (this.fullImgLoaded) {\n      return;\n    }\n    this.miniImgLoaded = true;\n    const ctx = this.elCanvas.getContext('2d');\n    const radio = this.width / img.width;\n    ctx.scale(radio, radio);\n    ctx.drawImage(img, 0, 0);\n    this.elCanvas.style.opacity = '1';\n  }\n\n  private loadMiniImg() {\n    if (!this.miniImgUrl) {\n      return;\n    }\n    loadImage(this.miniImgUrl)\n      .then(this.onMiniImgLoad.bind(this))\n      .catch(err => {\n        console.error(err);\n        if (this.isMiniImgFail() && this.isFullImgFail()) {\n          this.loadErrorImg();\n        } else {\n          setTimeout(() => {\n            // retry util full img loaded success\n            if (this.miniImgRetryCount < conf.retryTimes && !this.fullImgLoaded) {\n              this.miniImgRetryCount++;\n              this.loadMiniImg();\n            }\n          }, conf.retryDuration);\n        }\n      });\n  }\n\n  private onFullImgLoad() {\n    this.el.src = this.fullImgUrl;\n    this.elCanvas.style.opacity = '0';\n    this.el.setAttribute('data-fog-status', 'success');\n    this.fullImgLoaded = true;\n    this.onSuccess();\n    this.onComplete();\n  }\n\n  private loadFullImg() {\n    if (!this.fullImgUrl) {\n      throw Error('full img url is not found!');\n    }\n    loadImage(this.fullImgUrl)\n      .then(this.onFullImgLoad.bind(this))\n      .catch(err => {\n        console.error(err);\n        if (this.fullImgRetryCount < conf.retryTimes) {\n          this.fullImgRetryCount++;\n          setTimeout(() => {\n            this.loadFullImg();\n          }, conf.retryDuration);\n        } else {\n          this.onFail();\n          this.onComplete();\n          if (this.isMiniImgFail()) {\n            // load error img when mini and full img were all failed\n            this.loadErrorImg();\n          }\n        }\n      });\n  }\n\n  private loadErrorImg() {\n    if (!conf.errorImage || this.hasLoadErrImg) {\n      return;\n    }\n    this.hasLoadErrImg = true;\n    loadImage(conf.errorImage)\n      .then(() => {\n        this.el.src = conf.errorImage;\n        this.elCanvas.style.opacity = '0';\n      })\n      .catch(console.error);\n  }\n}\n","import {setConfig} from './global-config';\nimport Fog, {IFogOptions} from './fog';\n\nfunction init(options: IFogOptions) {\n  return new Fog(options);\n}\n\nexport default {init, setConfig};\n"],"names":["canvas","config","display","width","height","transitionDuration","retryTimes","retryDuration","loadImage","src","Promise","resolve","reject","img","Image","onload","bind","onerror","noop","options","this","el","getAttribute","conf","fullImgUrl","miniImgUrl","getMiniImgUrl","onFail","onSuccess","onComplete","prepareDOM","loadMiniImg","loadFullImg","Fog","url","miniImgRule","div","document","createElement","setAttribute","style","cssText","fullImgLoaded","fullImgRetryCount","miniImgLoaded","miniImgRetryCount","backgroundColor","fillStyle","ctx","getContext","save","fillRect","restore","toDataURL","getSkeletonImageURL","elDiv","createDiv","elCanvas","createCanvas","nextElementSibling","parentNode","insertBefore","appendChild","radio","scale","drawImage","opacity","then","onMiniImgLoad","catch","err","console","error","_this","isMiniImgFail","isFullImgFail","loadErrorImg","setTimeout","Error","onFullImgLoad","errorImage","hasLoadErrImg","init","setConfig","Object","assign"],"mappings":"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"}