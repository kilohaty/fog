!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.fog=i()}(this,function(){"use strict";var t,i={display:"inline-block",width:1,height:1,transitionDuration:1,retryTimes:2,retryDuration:3e3};function e(t){return new Promise(function(i,e){var n=new Image;n.crossOrigin="anonymous",n.onload=i.bind(null,n),n.onerror=e,n.src=t})}function n(){return!1}var o=function(){function o(t){this.miniImgRetryCount=0,this.fullImgRetryCount=0,this.miniImgLoaded=!1,this.fullImgLoaded=!1,this.hasLoadErrImg=!1,t instanceof HTMLElement&&(t={el:t}),this.el=t.el,this.width=+this.el.getAttribute("data-width")||i.width,this.height=+this.el.getAttribute("data-height")||i.height,this.fullImgUrl=this.el.getAttribute("data-src"),this.miniImgUrl=this.getMiniImgUrl(),this.onFail=t.onFail||n,this.onSuccess=t.onSuccess||n,this.onComplete=t.onComplete||n,this.prepareDOM(),this.loadMiniImg(),this.loadFullImg()}return o.prototype.getMiniImgUrl=function(){var t=this.el.getAttribute("data-src-mini");if(!t&&i.miniImgRule){var e=this.el.getAttribute("data-src");t=i.miniImgRule(e)}return t},o.prototype.createDiv=function(){var t=document.createElement("div");return t.setAttribute("class","fog-wrapper"),t.style.cssText="\n      display: "+i.display+"; \n      position: relative;\n      width: "+this.width+";\n      height: "+this.height+";\n      font-size: 0;",t},o.prototype.createCanvas=function(){var t=document.createElement("canvas");return t.width=this.width,t.height=this.height,t.style.cssText="\n      position: absolute; \n      z-index: 1;\n      left: 0;\n      top:0;\n      opacity: 0;\n      transition: opacity linear "+i.transitionDuration+"s;",t},o.prototype.isFullImgFail=function(){return!this.fullImgLoaded&&this.fullImgRetryCount>=i.retryTimes},o.prototype.isMiniImgFail=function(){return!this.miniImgLoaded&&this.miniImgRetryCount>=i.retryTimes},o.prototype.prepareDOM=function(){i.backgroundColor?this.el.src=function(i){t||((t=document.createElement("canvas")).width=1,t.height=1);var e=t.getContext("2d");return e.save(),e.fillStyle=i,e.fillRect(0,0,1,1),e.restore(),t.toDataURL()}(i.backgroundColor):this.el.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.elDiv=this.createDiv(),this.elCanvas=this.createCanvas(),this.el.nextElementSibling?this.el.parentNode.insertBefore(this.elDiv,this.el.nextElementSibling):this.el.parentNode.appendChild(this.elDiv),this.elDiv.appendChild(this.el),this.elDiv.appendChild(this.elCanvas)},o.prototype.onMiniImgLoad=function(t){if(this.miniImgLoaded=!0,!this.fullImgLoaded){var i=this.elCanvas.getContext("2d");i.save();var e=this.width/t.width;i.scale(e,e),i.drawImage(t,0,0),i.restore(),this.elCanvas.style.opacity="1"}},o.prototype.loadMiniImg=function(){var t=this;this.miniImgUrl&&e(this.miniImgUrl).then(this.onMiniImgLoad.bind(this)).catch(function(e){console.error(e),t.isMiniImgFail()&&t.isFullImgFail()?t.loadErrorImg():setTimeout(function(){t.miniImgRetryCount<i.retryTimes&&!t.fullImgLoaded&&(t.miniImgRetryCount++,t.loadMiniImg())},i.retryDuration)})},o.prototype.onFullImgLoad=function(){this.el.src=this.fullImgUrl,this.elCanvas.style.opacity="0",this.el.setAttribute("data-fog-status","success"),this.fullImgLoaded=!0,this.onSuccess(),this.onComplete()},o.prototype.loadFullImg=function(){var t=this;if(!this.fullImgUrl)throw Error("full img url is not found!");e(this.fullImgUrl).then(this.onFullImgLoad.bind(this)).catch(function(e){console.error(e),t.fullImgRetryCount<i.retryTimes?(t.fullImgRetryCount++,setTimeout(function(){t.loadFullImg()},i.retryDuration)):(t.onFail(),t.onComplete(),t.isMiniImgFail()&&t.loadErrorImg())})},o.prototype.loadErrorImg=function(){var t=this;i.errorImage&&!this.hasLoadErrImg&&(this.hasLoadErrImg=!0,e(i.errorImage).then(function(){t.el.src=i.errorImage,t.elCanvas.style.opacity="0"}).catch(console.error))},o}();return{init:function(t){return new o(t)},setConfig:function(t){Object.assign(i,t)}}});
//# sourceMappingURL=fog.js.map
